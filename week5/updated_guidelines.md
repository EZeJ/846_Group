# Week 5 Feedback: When “Avoid Implementation Details” Produces Misleading API Summaries

**Authors:** Liliana Hotsko, Alina Lytovchenko, Sofiia Tkach, Zesheng(Ethan) Jia

## 1. Counterexample Problems

### Problem A_1: Password Reset Token Verification Has a Hidden Security-Critical Branch

**Task Description:**
Write a **public-facing docstring** for `verify_reset_token(token: str) -> str` that is safe for developers to rely on.
The summary must clearly state:

* what is returned on success,
* what happens on invalid/expired tokens,
* the **security-critical behavior** (invalidating token after use),
* any important side effects (DB writes),
* possible exceptions.

**Starter Code:**

```python
# auth_reset.py
from __future__ import annotations
from dataclasses import dataclass
from datetime import datetime, timedelta
from typing import Dict, Optional
import hmac
import hashlib
import base64

class InvalidTokenError(Exception):
    pass

class ExpiredTokenError(Exception):
    pass

@dataclass
class ResetRecord:
    user_id: str
    token_hash: str
    expires_at: datetime
    used_at: Optional[datetime] = None

# In-memory store for simplicity
RESET_DB: Dict[str, ResetRecord] = {}  # key = token_id (public id)

def _hash_token(raw: str) -> str:
    return hashlib.sha256(raw.encode("utf-8")).hexdigest()

def issue_reset_token(user_id: str, ttl_minutes: int = 15) -> str:
    token_id = base64.urlsafe_b64encode(hashlib.sha1(user_id.encode()).digest()).decode().rstrip("=")
    raw = f"{token_id}:{user_id}:{int(datetime.utcnow().timestamp())}"
    sig = hmac.new(b"secret", raw.encode(), hashlib.sha256).hexdigest()
    token = f"{raw}:{sig}"

    RESET_DB[token_id] = ResetRecord(
        user_id=user_id,
        token_hash=_hash_token(token),
        expires_at=datetime.utcnow() + timedelta(minutes=ttl_minutes),
        used_at=None
    )
    return token

def verify_reset_token(token: str) -> str:
    """
    TODO
    """
    parts = token.split(":")
    if len(parts) != 4:
        raise InvalidTokenError("Malformed token")

    token_id, user_id, ts, sig = parts
    raw = f"{token_id}:{user_id}:{ts}"
    expected_sig = hmac.new(b"secret", raw.encode(), hashlib.sha256).hexdigest()
    if not hmac.compare_digest(sig, expected_sig):
        raise InvalidTokenError("Bad signature")

    rec = RESET_DB.get(token_id)
    if not rec:
        raise InvalidTokenError("Unknown token")

    # Security-critical: one-time use enforced
    if rec.used_at is not None:
        raise InvalidTokenError("Token already used")

    if datetime.utcnow() > rec.expires_at:
        raise ExpiredTokenError("Token expired")

    # Side effect: mark token as used (DB write)
    rec.used_at = datetime.utcnow()
    RESET_DB[token_id] = rec

    return rec.user_id
```

---

## 2. Guidelines that didn't work for Problem A_1

#### Guideline 4: Document Purpose and Contract, Not Implementation.

**Prompt and Context:**

> “Write a short docstring summary for `verify_reset_token` focusing on the high-level purpose.
> Avoid implementation details such as hashing/HMAC and internal storage. Keep it to 1–2 sentences. All code in week5/resources/updated_guideline5/auth_reset.py”

**Solution or Output generated by GitHub Copilot (not correct/optimal):**

```text
Verifies a password reset token and returns the associated user ID if valid.
```

**Why this is not correct/optimal for this counterexample:**

* It **omits the security-critical behavior**: the token is **one-time use** and is invalidated after successful verification.
* It **hides side effects**: the function performs a **DB write** (`used_at` update).
* It **does not mention failure modes**: invalid vs expired vs already-used tokens raise different exceptions.
* For an auth-related API, this “purpose-only” summary can mislead callers into assuming verification is a pure check and that tokens can be reused (which is false and security-relevant).

---

## 3. New and Updated Guidelines that worked for Problem A_1

#### Guideline 1 (New): “Purpose + Security-Relevant Contract”
This guideline extends “purpose + contract” with mandatory security-relevant contract elements for auth/token code. Instead of a generic purpose-only summary, it requires explicitly stating one key security property, any side effects, and failure modes/exceptions, while still avoiding cryptographic implementation details.

**Prompt and Context:**

> “Write a docstring summary for `verify_reset_token` intended for a public authentication API.
> Rules:
>
> 1. If the function is security/auth related (token/auth/password/reset), the summary MUST include: (a) one key security property, (b) side effects if any, and (c) failure modes/raised exceptions.
> 2. Do not describe cryptographic internals, but do state externally observable behavior (one-time use, expiration).
>    Keep it 2–4 sentences.
 All code in week5/resources/updated_guideline5/auth_reset.py”

**Solution or Output generated by GitHub Copilot (correct/optimal):**

```text
Validates a password reset token and returns the corresponding user ID on success.
Tokens are one-time use: a successful verification marks the token as used (state change) and prevents reuse.
Raises InvalidTokenError for malformed/unknown/bad-signature/already-used tokens, and ExpiredTokenError when the token is past its expiry time.
```

---
